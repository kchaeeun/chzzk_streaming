<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Viewer</title>
</head>
<body>
    <h2>시청자 페이지</h2>
    <!-- 2. viewer에서 영상 안나온 에러 해결 -->
    <video id="remoteVideo" autoplay playsinline muted></video> <!-- muted 추가 : muted가 없으면 Chrome/Edge/Firefox가 자동 재생을 막아서 화면이 안 나올 수 있음 -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const pc = new RTCPeerConnection();

        pc.ontrack = event => {
            document.getElementById("remoteVideo").srcObject = event.streams[0];
        };

        socket.on("offer", (offer) => {
            pc.setRemoteDescription(new RTCSessionDescription(offer))
            .then(() => pc.createAnswer())
            .then(answer => pc.setLocalDescription(answer))
            .then(() => {
                socket.emit("answer", pc.localDescription);
            })
        })

        socket.on("candidate", (candidate) => {
             if(candidate) {
                    pc.addIceCandidate(new RTCIceCandidate(candidate))
                    .catch(e => console.error("ICE candidate 추가 실패:", e));
            }
        })

        pc.oniceconnectionstatechange = () => {
            console.log("시청자 ICE 상태:", pc.iceConnectionState);
        };

        // 시청자가 늦게 들어왔을 때 offer 요청
        socket.emit("requestOffer");            // 2. viewer에서 영상 안나온 에러 해결

    </script>
</body>
</html>